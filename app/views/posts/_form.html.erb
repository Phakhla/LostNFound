<%= simple_form_for post, { data: { controller: 'maps post-preview', post_preview_target: 'form' } } do |f| %>

  <%= f.hidden_field :status, value: 'active' %>
  <%= f.hidden_field :category, data: { post_preview_target: 'categoryInput' } %>
  <%= f.hidden_field :lat, data: { maps_target: "latitude", post_preview_target: "latitude" } %>
  <%= f.hidden_field :lng, data: { maps_target: "longitude", post_preview_target: "longitude" } %>
  <%= f.hidden_field :location, data: { maps_target: "address", post_preview_target: "address" } %>

  <%= f.label "หัวข้อประกาศ" %>
  <%= f.input :name, input_html: { data: { post_preview_target: 'nameInput' } }, error: "กรุณากรอกข้อมูล" , label: false %>
  <br/>
  <div class="row g-5">
    <div class="col-sm-4">
      <%= f.label "ประเภท" %>
      <%= f.input :type_id, label: false, :collection => Type.all.map{ |l| [l.type_name, l.id] }, error: "กรุณาเลือกประเภท", include_blank: 'เลือก' %>
    </div>
    <div class="col-sm-4">
      <%= f.label "วันที่หาย" %>
      <%= f.input :date, as: :datetime, html5: true, input_html: { data: { post_preview_target: 'dateInput' } }, error: "กรุณาเลือกวันที่" , label: false %>
    </div>
  </div>
  <br>
  <%= f.label :images, "อัปโหลดรูป*"  %>
  <div class="box dropzone dropzone-box <%= 'form-invalid' if post.errors.key?(:images) %>" id="dropzone-container">
    <div class="dropzone dropzone-custom dz-clickable "  data-controller="dropzone" data-dropzone-max-file-size="0.5" data-dropzone-max-files="10">
      <%= f.file_field :images, multiple: true, direct_upload: true, data: { dropzone_target: 'input' } %>
      <div class="dropzone-msg dz-message ">
        <h3 class="plus"><i class="fa fa-plus "></i></h3>
      </div>
    </div>
    <div class="d-inline">
      <% if post.persisted? %>
        <% if post.images.attached? %>
          <% post.images.each do |image| %>
            <div class="m-2 d-inline-block" data-controller="post-image" data-post-image-target="image">
              <div class="d-flex image justify-content-center">
                <%= f.hidden_field :images, multiple: true, value: image.signed_id %>
                <%= image_tag(image, size: '150x150') %>
              </div>
              <%= button_tag "ลบภาพนี้", data: { action: 'click->post-image#removeImage' } %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>
  <% if post.errors.key?(:images) %>
      <p class="text-small text-danger">กรุณาอัพโหลดรูป</p>
  <% end %>
  <p class="color--red mt-3">*สามารถอัพโหลดรูปได้ไม่เกิน 10 รูป / ขนาดรูป 1080x720 px และขนาดไฟล์ไม่เกิน 500 KB</p>
  <%= f.label :detail, "รายละเอียดเพิ่มเติม", class: 'form-label' %>
  <%= f.input :detail, as: :text, input_html: { data: { post_preview_target: 'detailInput' }, rows: 5, class: 'form-control form-textarea' }, required: true, error: "กรุณากรอกข้อมูล", label: false, id: 'img' %>
  <br>
  <div class="mt-3">
    <label class="form-label">สถานที่หาย</label>
  </div>

  <div class="form-group mb-3">
    <% if post.persisted? %>
      <%= f.input :search, required: true, input_html: { data: { maps_target: "field", action: "keydown->maps#preventSubmit" }, value: post.location, class: post.errors.key?(:lat) || post.errors.key?(:lng) ? 'form-invalid' : 'form-control' }, label: false %>
    <% else %>
      <%= f.input :search, required: true, input_html: { data: { maps_target: "field", action: "keydown->maps#preventSubmit" }, value: '', class: post.errors.key?(:lat) || post.errors.key?(:lng) ? 'form-invalid' : 'form-control' }, label: false %>
    <% end %>
    <% if post.errors.key?(:lat) || post.errors.key?(:lng) %>
      <p class="text-small text-danger">กรุณากรอกข้อมูล</p>
    <% end %>
  </div>

  <%= content_tag :div, nil, data: { action: 'google-maps-callback@window->maps#initializeMap', maps_target: "map" }, class: 'map mb-5' %>

  <hr><br>
  <div class="d-grid gap-2 d-md-flex justify-content-md-end">
    <%= f.button :button, "ยกเลิก", type: "reset", class: "btn btn-outline-warning" %>
    <% if post.persisted? %>
      <%= f.submit "บันทึก", class: "btn btn-warning" %>
    <% else %>
      <%= f.button :button, "สร้างโพสต์", type: 'button', class: "btn btn-warning",
      data: {
        action: 'click->post-preview#preview'
      } %>
    <% end %>
    <%= render 'preview_modal', f: %>
  </div>
<% end %>
